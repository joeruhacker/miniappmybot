<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Магазин</title>
    <style>
        /* CSS стили */
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .product {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 15px;
        }
        .product h2 {
            margin-top: 0;
        }
        #cart {
            margin-top: 20px;
        }
        #payButton {
            padding: 10px 20px;
            font-size: 16px;
        }
        button {
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>Магазин цифровых товаров</h1>
    <div class="product">
        <h2>Robux</h2>
        <p>Цена: 100 руб.</p>
        <button onclick="addToCart('Robux', 100)">Добавить в корзину</button>
    </div>
    <div class="product">
        <h2>iTunes карта</h2>
        <p>Цена: 200 руб.</p>
        <button onclick="addToCart('iTunes карта', 200)">Добавить в корзину</button>
    </div>
    <div id="cart">
        <h2>Корзина</h2>
        <ul id="cartItems"></ul>
        <p>Итого: <span id="totalPrice">0</span> руб.</p>
        <button id="payButton" onclick="pay()" disabled>Оплатить</button>
    </div>

    <script>
        // Проверяем, доступен ли объект Telegram WebApp
        let tg = window.Telegram ? window.Telegram.WebApp : null;
        if (tg) {
            tg.expand(); // Расширяем на весь экран
        } else {
            console.warn('Telegram WebApp не доступен. Используется режим тестирования.');
        }

        // Получаем userId или используем заглушку для тестирования
        let userId = tg && tg.initDataUnsafe && tg.initDataUnsafe.user && tg.initDataUnsafe.user.id ? tg.initDataUnsafe.user.id : 'TEST_USER_ID';

        let cart = [];
        let totalPrice = 0;

        function addToCart(item, price) {
            cart.push({item: item, price: price});
            updateCart();
        }

        function updateCart() {
            let cartItems = document.getElementById('cartItems');
            cartItems.innerHTML = '';
            totalPrice = 0;
            cart.forEach(function(product) {
                let li = document.createElement('li');
                li.textContent = product.item + ' - ' + product.price + ' руб.';
                cartItems.appendChild(li);
                totalPrice += product.price;
            });
            document.getElementById('totalPrice').textContent = totalPrice;
            document.getElementById('payButton').disabled = cart.length === 0;
        }

        function pay() {
            // Отправка данных на вебхук n8n
            let data = {
                chat_id: userId,
                cart: cart,
                total_price: totalPrice
            };
            fetch('https://YOUR_N8N_WEBHOOK_URL', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            }).then(function(response) {
                if (response.ok) {
                    alert('Заказ отправлен! Проверьте бот для получения счета.');
                    if (tg) {
                        tg.close(); // Закрываем веб-приложение
                    } else {
                        console.warn('WebApp не может быть закрыт. Telegram WebApp не доступен.');
                    }
                } else {
                    alert('Ошибка при отправке заказа.');
                }
            }).catch(function(error) {
                console.error('Ошибка при отправке данных:', error);
                alert('Ошибка при отправке заказа.');
            });
        }
    </script>
</body>
</html>
