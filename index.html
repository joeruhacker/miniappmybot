<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Магазин цифровых товаров</title>
    <style>
        /* CSS стили */
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .product {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 15px;
        }
        .product h2 {
            margin-top: 0;
        }
        #cart {
            margin-top: 20px;
        }
        #payButton {
            padding: 10px 20px;
            font-size: 16px;
        }
        button {
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>Магазин цифровых товаров</h1>
    <div class="product">
        <h2>Robux</h2>
        <p>Цена: 100 руб.</p>
        <button onclick="addToCart('Robux', 100)">Добавить в корзину</button>
    </div>
    <div class="product">
        <h2>iTunes карта</h2>
        <p>Цена: 200 руб.</p>
        <button onclick="addToCart('iTunes карта', 200)">Добавить в корзину</button>
    </div>
    <div id="cart">
        <h2>Корзина</h2>
        <ul id="cartItems"></ul>
        <p>Итого: <span id="totalPrice">0</span> руб.</p>
        <button id="payButton" onclick="pay()" disabled>Оплатить</button>
    </div>

    <script>
        // Инициализация Telegram Web App
        let tg = window.Telegram ? window.Telegram.WebApp : null;

        let userId;
        if (tg) {
            // Расширяем на весь экран (опционально)
            tg.expand();

            // Получаем userId
            if (tg.initDataUnsafe && tg.initDataUnsafe.user && tg.initDataUnsafe.user.id) {
                userId = tg.initDataUnsafe.user.id;
                console.log('User ID:', userId);
            } else {
                console.error('Не удалось получить идентификатор пользователя');
                alert('Ошибка: Пожалуйста, откройте приложение внутри Telegram.');
            }
        } else {
            console.warn('Telegram WebApp не доступен. Приложение должно быть запущено внутри Telegram.');
            // Для тестирования вне Telegram можно задать тестовый userId
            userId = '5371541339';
        }

        let cart = [];
        let totalPrice = 0;

        function addToCart(item, price) {
            cart.push({item: item, price: price});
            updateCart();
            console.log('Товар добавлен в корзину:', item, price);
        }

        function updateCart() {
            let cartItems = document.getElementById('cartItems');
            cartItems.innerHTML = '';
            totalPrice = 0;
            cart.forEach(function(product) {
                let li = document.createElement('li');
                li.textContent = product.item + ' - ' + product.price + ' руб.';
                cartItems.appendChild(li);
                totalPrice += product.price;
            });
            document.getElementById('totalPrice').textContent = totalPrice;
            document.getElementById('payButton').disabled = cart.length === 0;
            console.log('Корзина обновлена:', cart, 'Общая сумма:', totalPrice);
        }

        function pay() {
            // Проверяем, что userId получен
            if (!userId || userId === 'TEST_USER_ID') {
                console.error('userId не определен или является тестовым');
                alert('Ошибка: Не удалось получить идентификатор пользователя.');
                return;
            }

            // Отправка данных на вебхук n8n
            let data = {
                chat_id: userId,
                cart: cart,
                total_price: totalPrice
            };

            console.log('Отправляемые данные:', data);

            fetch('https://n8n.chatforma.com/webhook/webhook', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            })
            .then(function(response) {
                if (response.ok) {
                    console.log('Заказ успешно отправлен');
                    alert('Заказ отправлен! Проверьте бот для получения счета.');
                    if (tg) {
                        tg.close(); // Закрываем веб-приложение
                    }
                } else {
                    response.text().then(function(text) {
                        console.error('Ошибка при отправке заказа:', response.status, text);
                        alert('Ошибка при отправке заказа.');
                    });
                }
            })
            .catch(function(error) {
                console.error('Ошибка при отправке данных:', error);
                alert('Ошибка при отправке заказа.');
            });
        }
    </script>
</body>
</html>
